<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pizarro • Seguimiento</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>

<header class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <img src="/static/pizarro-logo.png" alt="Pizarro">
      <div class="title">Seguimiento</div>
    </div>

    <div class="subtle" style="display:flex; gap:12px; align-items:center;">
      <span title="{{ vendor_email }}">{{ vendor_email }}</span>

      {% if is_admin %}
        <a href="/admin" style="color:rgba(255,255,255,.95); font-weight:800;">
          Panel Admin
        </a>
      {% endif %}

      <a href="/logout" style="color:rgba(255,255,255,.85); font-weight:800;">
        Salir
      </a>
    </div>
  </div>
</header>

<main class="container">

  {% if msg %}
    <div class="notice {{ msg_type }}">{{ msg }}</div>
  {% endif %}

  <!-- ================= KPIs ================= -->
   {% if kpis %}
<div class="card">
  <h2 style="margin-top:0;">KPIs (Mes)</h2>

  <div class="row" style="gap:12px; margin-top:10px;">
    <div class="col">
      <div class="card" style="box-shadow:none;">
        <div><b>Mes actual</b> <small>({{ kpis.month.from }} → {{ kpis.month.to }})</small></div>
        <div style="margin-top:8px;"><small>Cotizaciones:</small> <b>{{ kpis.month.quotes.total }}</b></div>
        <div><small>Cerradas:</small> {{ kpis.month.quotes.cerrada }}</div>
        <div><small>Perdidas:</small> {{ kpis.month.quotes.perdida }}</div>
        <div><small>Pendientes:</small> {{ kpis.month.quotes.pendiente }}</div>

        <div style="margin-top:8px;">
          <small>% cierre:</small>
          <b>{% if kpis.month.close_rate is not none %}{{ kpis.month.close_rate }}%{% else %}-{% endif %}</b>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card" style="box-shadow:none;">
        <div><b>Mes anterior</b> <small>({{ kpis.prev_month.from }} → {{ kpis.prev_month.to }})</small></div>
        <div style="margin-top:8px;"><small>Cotizaciones:</small> <b>{{ kpis.prev_month.quotes.total }}</b></div>
        <div><small>Cerradas:</small> {{ kpis.prev_month.quotes.cerrada }}</div>
        <div><small>Perdidas:</small> {{ kpis.prev_month.quotes.perdida }}</div>

        <div style="margin-top:8px;">
          <small>% cierre:</small>
          <b>{% if kpis.prev_month.close_rate is not none %}{{ kpis.prev_month.close_rate }}%{% else %}-{% endif %}</b>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card" style="box-shadow:none;">
        <div><b>Comparación</b> <small>(Mes vs anterior)</small></div>

        <div style="margin-top:8px;">
          <small>Δ cotizaciones:</small>
          <b>{{ kpis.compare.quotes_total_delta }}</b>
          {% if kpis.compare.quotes_total_delta_pct is not none %}
            <small>({{ '%.1f'|format(kpis.compare.quotes_total_delta_pct) }}%)</small>
          {% endif %}
        </div>

        <div>
          <small>Δ cerradas:</small>
          <b>{{ kpis.compare.quotes_cerrada_delta }}</b>
          {% if kpis.compare.quotes_cerrada_delta_pct is not none %}
            <small>({{ '%.1f'|format(kpis.compare.quotes_cerrada_delta_pct) }}%)</small>
          {% endif %}
        </div>

        <div>
          <small>Δ postventas:</small>
          <b>{{ kpis.compare.postventas_total_delta }}</b>
          {% if kpis.compare.postventas_total_delta_pct is not none %}
            <small>({{ '%.1f'|format(kpis.compare.postventas_total_delta_pct) }}%)</small>
          {% endif %}
        </div>

        <div style="margin-top:8px;">
          <small>Alertas:</small>
          <div><b>{{ kpis.alerts.old_open_quotes }}</b> cotizaciones abiertas con +{{ kpis.alerts.older_than_days }} días</div>
        </div>
      </div>
    </div>
  </div>

  <div style="margin-top:10px;">
    <small><b>Histórico:</b> {{ kpis.lifetime.quotes.total }} cotizaciones • {{ kpis.lifetime.postventas.total }} postventas</small>
  </div>
</div>
{% endif %}

  {% if kpis %}
  <div class="card">
    <h2 style="margin-top:0;">KPIs</h2>

    <div class="row" style="gap:12px; margin-top:10px; flex-wrap:wrap;">
      <div class="col">
        <div class="card" style="box-shadow:none;">
          <b>Cotizaciones</b>
          <div><small>Total:</small> {{ kpis.quotes.total }}</div>
          <div><small>Pendientes:</small> {{ kpis.quotes.pendiente }}</div>
          <div><small>Cerradas:</small> {{ kpis.quotes.cerrada }}</div>
          <div><small>Perdidas:</small> {{ kpis.quotes.perdida }}</div>
          <div style="margin-top:6px;">
            <small>% cierre:</small>
            <b>
              {% if kpis.close_rate is not none %}
                {{ kpis.close_rate }}%
              {% else %}
                -
              {% endif %}
            </b>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card" style="box-shadow:none;">
          <b>Postventas</b>
          <div><small>Total:</small> {{ kpis.postventas.total }}</div>
          <div><small>Pendientes:</small> {{ kpis.postventas.pendiente }}</div>
          <div><small>Realizadas:</small> {{ kpis.postventas.realizada }}</div>
          <div><small>Canceladas:</small> {{ kpis.postventas.cancelada }}</div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- ================= SUBIR COTIZACIÓN ================= -->
  <div class="card">
    <div class="actions" style="margin-bottom:10px;">
      <a class="btn btn-primary" href="/ui/postventa/new">+ Nueva postventa</a>
    </div>

    <h1>Subir cotización (PDF)</h1>
    <small>
      Se crean recordatorios a 48h y 72h en tu Google Calendar (si no está duplicada).
    </small>

    <div style="margin-top:12px;">
      {% if is_connected %}
        <span class="badge">Calendar conectado ✅</span>
      {% else %}
        <div class="notice error">
          No estás conectado a Google Calendar.
          <a href="/login">Reconectar Google</a>
        </div>
      {% endif %}
    </div>

    <form action="/ui/upload" method="post" enctype="multipart/form-data" style="margin-top:14px;">
      <label>PDF</label>
      <input type="file" name="pdf" accept="application/pdf" required>

      <div class="actions">
        <button class="btn btn-primary" type="submit">
          Subir y crear recordatorios
        </button>
        <a class="btn btn-secondary" href="/ui">Refrescar</a>
      </div>
    </form>
  </div>

  <!-- ================= COTIZACIONES ================= -->
  <div class="card">
    <h2>Cotizaciones</h2>

    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th>Número</th>
            <th>Estado</th>
            <th>Resumen</th>
            <th>Fecha</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for q in quotes %}
          <tr>
            <td data-label="Número"><b>{{ q.quote_number }}</b></td>
            <td data-label="Estado">
              <span class="badge status-{{ q.status or 'pendiente' }}">
                {{ q.status or 'pendiente' }}
              </span>
            </td>
            <td data-label="Resumen">{{ q.summary or '' }}</td>
            <td data-label="Fecha"><small>{{ q.created_at }}</small></td>
            <td data-label="Acción">
              <a href="/ui/quote?quote_number={{ q.quote_number }}">Abrir</a>
            </td>
          </tr>
          {% endfor %}

          {% if quotes|length == 0 %}
          <tr>
            <td colspan="5"><small>No hay cotizaciones todavía.</small></td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ================= POSTVENTAS ================= -->
  <div class="card">
    <h2>Postventas (sin cotización)</h2>

    <div class="actions" style="margin-bottom:10px;">
      <a class="btn btn-primary" href="/ui/postventa/new">+ Nueva postventa</a>
    </div>

    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Cliente</th>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Estado</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for p in postventas %}
          <tr>
            <td data-label="ID"><b>#{{ p.id }}</b></td>
            <td data-label="Cliente">{{ p.client_name }}</td>
            <td data-label="Fecha"><small>{{ p.postventa_date }}</small></td>
            <td data-label="Tipo">{{ p.type or '' }}</td>
            <td data-label="Estado">
              <span class="badge">{{ p.status or 'pendiente' }}</span>
            </td>
            <td data-label="Acción">
              <a href="/ui/postventa?postventa_id={{ p.id }}">Abrir</a>
            </td>
          </tr>
          {% endfor %}

          {% if postventas|length == 0 %}
          <tr>
            <td colspan="6"><small>No hay postventas todavía.</small></td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

</main>
</body>
</html>
