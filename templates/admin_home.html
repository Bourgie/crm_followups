<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Pizarro • Panel Encargado</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>

<body>

<header class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <img src="/static/pizarro-logo.png" alt="Pizarro">
      <div class="title">Panel Encargado</div>
    </div>

    <div class="subtle" style="display:flex; gap:12px; align-items:center;">
      <span title="{{ admin_email }}">{{ admin_email }}</span>

      <a href="/ui" style="color:rgba(255,255,255,.95); font-weight:800;">
        Volver a Vendedor
      </a>

      <a href="/logout" style="color:rgba(255,255,255,.85); font-weight:800;">
        Salir
      </a>
    </div>
  </div>
</header>

<main class="container">

  {# Seguridad si backend no manda filters #}
  {% set filters = filters or {} %}

  {% if msg %}
    <div class="notice {{ msg_type }}">{{ msg }}</div>
  {% endif %}

  {# ================= KPIs ================= #}
  {% if kpis_global %}
  <div class="card">
    <h2 style="margin-top:0;">KPIs (Mes)</h2>

    <div class="row" style="gap:12px; margin-top:10px;">
      <div class="col">
        <div class="card" style="box-shadow:none;">
          <div>
            <b>Global</b>
            <small>({{ kpis_global.month.from }} → {{ kpis_global.month.to }})</small>
          </div>

          <div style="margin-top:8px;">
            <small>Cotizaciones:</small>
            <b>{{ kpis_global.month.quotes.total }}</b>
          </div>
          <div><small>Cerradas:</small> {{ kpis_global.month.quotes.cerrada }}</div>
          <div><small>Perdidas:</small> {{ kpis_global.month.quotes.perdida }}</div>
          <div><small>Pendientes:</small> {{ kpis_global.month.quotes.pendiente }}</div>

          <div style="margin-top:8px;">
            <small>% cierre:</small>
            <b>
              {% if kpis_global.month.close_rate is not none %}
                {{ kpis_global.month.close_rate }}%
              {% else %}
                -
              {% endif %}
            </b>
          </div>

          <div style="margin-top:8px;">
            <small>Alertas (+{{ kpis_global.alerts.older_than_days }}d abiertas):</small>
            <b>{{ kpis_global.alerts.old_open_quotes }}</b>
          </div>
        </div>
      </div>

      {% if kpis_vendor %}
      <div class="col">
        <div class="card" style="box-shadow:none;">
          <div>
            <b>Vendedor filtrado</b>
            <small>({{ filters.get('vendor_id') }})</small>
          </div>

          <div style="margin-top:8px;">
            <small>Cotizaciones:</small>
            <b>{{ kpis_vendor.month.quotes.total }}</b>
          </div>
          <div><small>Cerradas:</small> {{ kpis_vendor.month.quotes.cerrada }}</div>
          <div><small>Perdidas:</small> {{ kpis_vendor.month.quotes.perdida }}</div>
          <div><small>Pendientes:</small> {{ kpis_vendor.month.quotes.pendiente }}</div>

          <div style="margin-top:8px;">
            <small>% cierre:</small>
            <b>
              {% if kpis_vendor.month.close_rate is not none %}
                {{ kpis_vendor.month.close_rate }}%
              {% else %}
                -
              {% endif %}
            </b>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  {# ================= Ranking ================= #}
  {% if ranking %}
  <div class="card">
    <h2 style="margin-top:0;">Ranking vendedores (mes)</h2>

    <div class="table-wrap" style="margin-top:10px;">
      <table class="table">
        <thead>
          <tr>
            <th>Vendedor</th>
            <th>Cotizaciones</th>
            <th>Cerradas</th>
            <th>% cierre</th>
            <th>Postventas</th>
          </tr>
        </thead>
        <tbody>
          {% for r in ranking %}
          <tr>
            <td><small>{{ r.vendor_id }}</small></td>
            <td>{{ r.quotes_total }}</td>
            <td>{{ r.quotes_cerrada }}</td>
            <td>
              {% if r.close_rate is not none %}
                {{ r.close_rate }}%
              {% else %}
                -
              {% endif %}
            </td>
            <td>{{ r.postventas_total }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {# ================= Filtros ================= #}
  <div class="card">
    <h1>Filtros</h1>

    <form method="get" action="/admin" class="row" style="align-items:end;">
      <div class="col">
        <label>Vendedor</label>
        <select name="vendor_id">
          <option value="">(Todos)</option>
          {% for v in vendors %}
            <option value="{{ v }}" {{ 'selected' if v == (filters.get('vendor_id') or '') else '' }}>
              {{ v }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col">
        <label>Estado</label>
        <select name="status">
          <option value="">(Todos)</option>
          {% for s in ['pendiente','contactado','interesado','cerrada','perdida','cancelada'] %}
            <option value="{{ s }}" {{ 'selected' if s == (filters.get('status') or '') else '' }}>
              {{ s }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col">
        <label>Tipo</label>
        {% set k = filters.get('kind') or 'all' %}
        <select name="kind">
          <option value="all" {{ 'selected' if k in ['all','',None] else '' }}>(Todo)</option>
          <option value="quote" {{ 'selected' if k == 'quote' else '' }}>Cotizaciones</option>
          <option value="postventa" {{ 'selected' if k == 'postventa' else '' }}>Postventas</option>
        </select>
      </div>

      <div class="col">
        <label>Desde</label>
        <input type="text" name="date_from" placeholder="YYYY-MM-DD" value="{{ filters.get('date_from') or '' }}">
      </div>

      <div class="col">
        <label>Hasta</label>
        <input type="text" name="date_to" placeholder="YYYY-MM-DD" value="{{ filters.get('date_to') or '' }}">
      </div>

      <div class="actions" style="margin-top:10px;">
        <button class="btn btn-primary" type="submit">Aplicar</button>
        <a class="btn btn-secondary" href="/admin">Limpiar</a>
      </div>
    </form>
  </div>

  {# ================= Resultados ================= #}
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
      <div>
        <h2 style="margin:0;">Resultados</h2>
        <small>Total: {{ items|length }}</small>
      </div>

      <a class="btn btn-secondary"
         href="/admin/export.xlsx?vendor_id={{ (filters.get('vendor_id') or '') | urlencode }}&status={{ (filters.get('status') or '') | urlencode }}&kind={{ (filters.get('kind') or 'all') | urlencode }}&date_from={{ (filters.get('date_from') or '') | urlencode }}&date_to={{ (filters.get('date_to') or '') | urlencode }}">
        Exportar a Excel
      </a>
    </div>

    <div class="table-wrap" style="margin-top:10px;">
      <table class="table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Vendedor</th>
            <th>Cliente</th>
            <th>Ref</th>
            <th>Estado</th>
            <th>Total</th>
            <th>Resumen</th>
          </tr>
        </thead>

        <tbody>
          {% for it in items %}
          <tr>
            <td><small>{{ it.date }}</small></td>
            <td>{{ it.kind }}</td>
            <td><small>{{ it.vendor_id }}</small></td>
            <td>{{ it.client_name }}</td>
            <td><b>{{ it.ref }}</b></td>
            <td><span class="badge">{{ it.status }}</span></td>
            <td>{{ it.total }}</td>
            <td>{{ it.summary }}</td>
          </tr>
          {% endfor %}

          {% if items|length == 0 %}
          <tr>
            <td colspan="8"><small>No hay resultados con esos filtros.</small></td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

</main>
</body>
</html>

